<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .loading { background: #fff3cd; color: #856404; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
        }
        #reader {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border: 2px dashed #ccc;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤ - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h1>
    
    <div id="status" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏...</div>
    
    <div id="reader">
        –ö–∞–º–µ—Ä–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å
    </div>
    
    <button onclick="startScanner()" id="scan-btn" disabled>–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
    <button onclick="stopScanner()" id="stop-btn" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    
    <div id="result"></div>

                    <script>
let html5Qrcode = null;
let isScanning = false;

// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ...

window.startScanner = async function() {
    const statusDiv = document.getElementById('status');
    const resultDiv = document.getElementById('result');
    
    if (isScanning) {
        statusDiv.innerHTML = '‚ö†Ô∏è –°–∫–∞–Ω–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω';
        return;
    }
    
    try {
        statusDiv.innerHTML = 'üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–∞–º–µ—Ä—ã...';
        
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
        const cameras = await Html5Qrcode.getCameras();
        console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞–º–µ—Ä—ã:', cameras);
        
        if (cameras.length === 0) {
            throw new Error('–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ');
        }
        
        statusDiv.innerHTML = 'üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∫–∞–Ω–µ—Ä...';
        
        // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–∫–∞–Ω–µ—Ä–∞
        html5Qrcode = new Html5Qrcode("reader");
        console.log('–°–∫–∞–Ω–µ—Ä —Å–æ–∑–¥–∞–Ω');
        
        statusDiv.innerHTML = 'üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É... –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø';
        
        // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 150 },
            aspectRatio: 1.333334
        };
        
        // –ü—Ä–æ–±—É–µ–º —Å–Ω–∞—á–∞–ª–∞ –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É, –ø–æ—Ç–æ–º –ª—é–±—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é
        let cameraId = null;
        
        // –ò—â–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
        const rearCamera = cameras.find(cam => cam.label.toLowerCase().includes('back') || cam.label.includes('–∑–∞–¥–Ω'));
        if (rearCamera) {
            cameraId = rearCamera.id;
            console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É:', rearCamera.label);
        } else {
            cameraId = cameras[0].id; // –ü–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞–º–µ—Ä–∞
            console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –∫–∞–º–µ—Ä—É:', cameras[0].label);
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä
        await html5Qrcode.start(
            cameraId, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–∞–º–µ—Ä—É
            config,
            function(decodedText, decodedResult) {
                console.log('‚úÖ –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:', decodedText);
                resultDiv.innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 5px;">
                        <h3>‚úÖ –®—Ç—Ä–∏—Ö-–∫–æ–¥ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω!</h3>
                        <p><strong>–ö–æ–¥:</strong> ${decodedText}</p>
                        <button onclick="testAgain()">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—â–µ</button>
                    </div>
                `;
                stopScanner();
            },
            function(error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–æ –ª–æ–≥–∏—Ä—É–µ–º)
                console.log('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–æ—Ä–º–∞–ª—å–Ω–æ):', error);
            }
        );
        
        isScanning = true;
        document.getElementById('scan-btn').disabled = true;
        document.getElementById('stop-btn').disabled = false;
        statusDiv.innerHTML = '‚úÖ –°–∫–∞–Ω–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω! –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥';
        statusDiv.style.background = '#d4edda';
        
    } catch (error) {
        console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', error);
        
        let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        if (error && error.message) {
            errorMessage = error.message;
        } else if (typeof error === 'string') {
            errorMessage = error;
        }
        
        statusDiv.className = 'error';
        statusDiv.innerHTML = `
            ‚ùå –û—à–∏–±–∫–∞: ${errorMessage}<br><br>
            <small>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:<br>
            ‚Ä¢ –ù–µ —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ<br>
            ‚Ä¢ –ö–∞–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º<br>
            ‚Ä¢ –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ<br>
            ‚Ä¢ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –ø–æ HTTP (–Ω—É–∂–µ–Ω HTTPS –∏–ª–∏ localhost)</small>
        `;
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        resultDiv.innerHTML = `
            <div style="text-align: left; background: #fff3cd; padding: 15px; border-radius: 5px;">
                <h4>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:</h4>
                <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                <p><strong>HTTPS:</strong> ${window.location.protocol === 'https:' ? '–î–∞' : '–ù–µ—Ç'}</p>
                <p><strong>Localhost:</strong> ${window.location.hostname === 'localhost' ? '–î–∞' : '–ù–µ—Ç'}</p>
                <p><strong>MediaDevices:</strong> ${navigator.mediaDevices ? '–î–æ—Å—Ç—É–ø–Ω–æ' : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ'}</p>
            </div>
        `;
    }
};

window.stopScanner = async function() {
    if (html5Qrcode && isScanning) {
        try {
            await html5Qrcode.stop();
            isScanning = false;
            document.getElementById('scan-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('status').innerHTML = '‚úÖ –°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
            document.getElementById('status').style.background = '';
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:', error);
        }
    }
};

function testAgain() {
    document.getElementById('result').innerHTML = '';
    startScanner();
}

// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...
</script>
</body>
</html>
