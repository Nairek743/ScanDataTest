<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤ 1–°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        #status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            text-align: center;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { padding: 15px; font-size: 16px; margin: 10px; width: 100%; }
        #reader { width: 100%; height: 300px; border: 2px dashed #ccc; margin: 20px 0; }
    </style>
    
    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º CDN —Å HTTPS -->
    <script src="https://raw.githubusercontent.com/mebjas/html5-qrcode/master/minified/html5-qrcode.min.js"></script>
</head>
<body>
    <h1>–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤</h1>
    
    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="reader"></div>
    
    <button onclick="startScanner()" id="scan-btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
    <button onclick="stopScanner()" id="stop-btn" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    
    <div id="result"></div>

    <script>
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        function waitForLibrary(callback) {
            let attempts = 0;
            const maxAttempts = 50; // 5 —Å–µ–∫—É–Ω–¥
            
            function check() {
                attempts++;
                if (typeof Html5Qrcode !== 'undefined') {
                    callback(true);
                } else if (attempts < maxAttempts) {
                    setTimeout(check, 100);
                } else {
                    callback(false);
                }
            }
            check();
        }
        
        waitForLibrary(function(success) {
            const statusDiv = document.getElementById('status');
            if (success) {
                statusDiv.className = 'success';
                statusDiv.innerHTML = '‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞!';
                document.getElementById('scan-btn').disabled = false;
            } else {
                statusDiv.className = 'error';
                statusDiv.innerHTML = '‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å';
            }
        });
        
        let html5Qrcode = null;
        let isScanning = false;
        
        window.startScanner = async function() {
            const statusDiv = document.getElementById('status');
            
            try {
                statusDiv.innerHTML = 'üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É...';
                
                html5Qrcode = new Html5Qrcode("reader");
                
                await html5Qrcode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: 250 },
                    function(decodedText) {
                        document.getElementById('result').innerHTML = 
                            `<div style="background: #d4edda; padding: 15px;">
                                <h3>‚úÖ –£—Å–ø–µ—Ö!</h3>
                                <p>–®—Ç—Ä–∏—Ö-–∫–æ–¥: ${decodedText}</p>
                             </div>`;
                        stopScanner();
                    },
                    function() {} // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                );
                
                isScanning = true;
                document.getElementById('scan-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
                statusDiv.innerHTML = '‚úÖ –°–∫–∞–Ω–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω';
                
            } catch (error) {
                statusDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            }
        };
        
        window.stopScanner = async function() {
            if (html5Qrcode && isScanning) {
                await html5Qrcode.stop();
                isScanning = false;
                document.getElementById('scan-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
            }
        };
    </script>
</body>
</html>
